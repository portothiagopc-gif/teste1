--// SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

--// CONFIG
local ESP_ENABLED = true
local TEAM_CHECK = true

--// GUI
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 220, 0, 120)
Frame.Position = UDim2.new(0, 20, 0, 100)
Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,0,0,30)
Title.Text = "ESP TEST (Highlight)"
Title.TextColor3 = Color3.new(1,1,1)
Title.BackgroundColor3 = Color3.fromRGB(35,35,35)
Title.BorderSizePixel = 0

local EspBtn = Instance.new("TextButton", Frame)
EspBtn.Size = UDim2.new(1,-20,0,30)
EspBtn.Position = UDim2.new(0,10,0,40)
EspBtn.Text = "ESP: ON"

local TeamBtn = Instance.new("TextButton", Frame)
TeamBtn.Size = UDim2.new(1,-20,0,30)
TeamBtn.Position = UDim2.new(0,10,0,75)
TeamBtn.Text = "TEAM CHECK: ON"

--// BUTTON LOGIC
EspBtn.MouseButton1Click:Connect(function()
	ESP_ENABLED = not ESP_ENABLED
	EspBtn.Text = ESP_ENABLED and "ESP: ON" or "ESP: OFF"
end)

TeamBtn.MouseButton1Click:Connect(function()
	TEAM_CHECK = not TEAM_CHECK
	TeamBtn.Text = TEAM_CHECK and "TEAM CHECK: ON" or "TEAM CHECK: OFF"
end)

--// ESP SYSTEM
local Highlights = {}

local function ApplyESP(player)
	if player == LocalPlayer then return end

	local function onCharacter(char)
		if Highlights[player] then
			Highlights[player]:Destroy()
		end

		local hl = Instance.new("Highlight")
		hl.FillTransparency = 0.5
		hl.OutlineTransparency = 0
		hl.Parent = char

		Highlights[player] = hl
	end

	if player.Character then
		onCharacter(player.Character)
	end

	player.CharacterAdded:Connect(onCharacter)
end

local function RemoveESP(player)
	if Highlights[player] then
		Highlights[player]:Destroy()
		Highlights[player] = nil
	end
end

--// UPDATE LOOP
task.spawn(function()
	while task.wait(0.5) do
		for _, player in ipairs(Players:GetPlayers()) do
			if player ~= LocalPlayer and player.Character then

				if TEAM_CHECK
					and player.Team ~= nil
					and LocalPlayer.Team ~= nil
					and player.Team == LocalPlayer.Team then

					RemoveESP(player)
					continue
				end

				if ESP_ENABLED then
					if not Highlights[player] then
						ApplyESP(player)
					end
				else
					RemoveESP(player)
				end
			end
		end
	end
end)

Players.PlayerRemoving:Connect(RemoveESP)
